# CLI Reference

Command-line interface for gh-year-end.

## Commands Overview

| Command | Purpose | Common Flags |
|---------|---------|--------------|
| `collect` | Collect GitHub data and generate metrics JSON | `--config`, `--force` |
| `build` | Build static HTML site from metrics JSON | `--config` |
| `all` | Run complete pipeline (collect + build) | `--config`, `--force` |

### Deprecated Commands

The following commands are deprecated and will be removed in a future version:

| Command | Status | Migration |
|---------|--------|-----------|
| `plan` | Deprecated | Use `collect --help` |
| `status` | Deprecated | No longer needed (single-pass collection) |
| `normalize` | Deprecated | Replaced by `collect` (single-pass) |
| `metrics` | Deprecated | Replaced by `collect` (single-pass) |
| `report` | Deprecated | Use `build` instead |
| `validate` | Deprecated | No longer needed (single-pass collection) |

## Entry Point

```bash
gh-year-end [OPTIONS] COMMAND [ARGS]...
```

GitHub Year-End Community Health Report Generator. Generates comprehensive year-end reports for GitHub organizations or users, including activity metrics, leaderboards, and repository health scores.

## Global Options

| Option | Short | Description |
|--------|-------|-------------|
| `--version` | | Show version and exit |
| `--verbose` | `-v` | Enable verbose output (includes tracebacks on errors) |
| `--help` | | Show help message and exit |

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `GITHUB_TOKEN` | Yes | GitHub personal access token for API authentication |

Generate token at: https://github.com/settings/tokens

Required scopes: `repo`, `read:org`, `read:user`

## Commands

### plan

Preview collection plan without making changes.

```bash
gh-year-end plan --config CONFIG
```

**Options:**

| Option | Short | Required | Description |
|--------|-------|----------|-------------|
| `--config` | `-c` | Yes | Path to config.yaml file |

**Output:**

- Target org/user
- Year and time window
- Enabled data collectors
- Storage root path

**Example:**

```bash
gh-year-end plan -c config/config.yaml
```

---

### collect

Collect GitHub data and generate metrics JSON.

```bash
gh-year-end collect --config CONFIG [OPTIONS]
```

Performs single-pass collection with in-memory metric aggregation, then writes results to JSON files for the website.

The collection process:
1. Discovers all repositories in the target org/user
2. Collects PRs, issues, reviews, comments, commits
3. Aggregates metrics in-memory (no intermediate files)
4. Writes final JSON files to site/{year}/data/

**Options:**

| Option | Short | Required | Description |
|--------|-------|----------|-------------|
| `--config` | `-c` | Yes | Path to config.yaml file |
| `--force` | `-f` | No | Force re-collection even if data exists |

**Output:**

JSON files in `site/{year}/data/`:

- `summary.json` - Overall statistics
- `leaderboards.json` - Ranked contributors by metric
- `timeseries.json` - Weekly/monthly activity trends
- `repo_health.json` - Per-repository health metrics
- `hygiene_scores.json` - Repository hygiene/quality scores
- `awards.json` - Top contributor awards

**Example:**

```bash
# Fresh collection
gh-year-end collect -c config/config.yaml

# Force re-collection
gh-year-end collect -c config/config.yaml --force
```

---

### build

Build static HTML site from metrics JSON.

```bash
gh-year-end build --config CONFIG
```

Reads the JSON files generated by 'collect' and renders HTML templates using Jinja2. Creates a complete static site with:

- Executive summary dashboard
- Contributor leaderboards
- Repository health metrics
- Interactive D3.js visualizations
- Time series activity charts

**Options:**

| Option | Short | Required | Description |
|--------|-------|----------|-------------|
| `--config` | `-c` | Yes | Path to config.yaml file |

**Input:**

JSON files from `site/{year}/data/`

**Output:**

Static HTML site in `site/{year}/`:

- `index.html` - Main landing page
- `summary.html` - Executive summary view
- `leaderboards.html` - Contributor leaderboards
- `repos.html` - Repository health metrics
- `awards.html` - Top contributor awards
- `assets/` - CSS, JavaScript, D3 visualizations

**Example:**

```bash
gh-year-end build -c config/config.yaml
```

**Viewing the site:**

```bash
python -m http.server -d site/2025
# Open http://localhost:8000 in browser
```

---

### all

Run complete pipeline: collect data and build site.

```bash
gh-year-end all --config CONFIG [OPTIONS]
```

This is a convenience command that runs both 'collect' and 'build' in sequence. Equivalent to:

```bash
gh-year-end collect --config CONFIG
gh-year-end build --config CONFIG
```

**Options:**

| Option | Short | Required | Description |
|--------|-------|----------|-------------|
| `--config` | `-c` | Yes | Path to config.yaml file |
| `--force` | `-f` | No | Force re-collection even if data exists |

**Example:**

```bash
# First-time full report
gh-year-end all -c config/config.yaml

# Force re-collection and regeneration
gh-year-end all -c config/config.yaml --force
```

---

## Deprecated Commands

The following commands are part of the old multi-phase pipeline and are deprecated. They will be removed in a future version.

### plan (DEPRECATED)

Preview collection plan without making changes. **Use `gh-year-end collect --help` instead.**

---

### status (DEPRECATED)

Show collection progress from checkpoint. **No longer needed with single-pass collection.**

---

### normalize (DEPRECATED)

Convert raw JSONL to curated Parquet tables. **Replaced by `gh-year-end collect` which performs single-pass collection and aggregation.**

---

### metrics (DEPRECATED)

Compute metrics from curated data. **Replaced by `gh-year-end collect` which performs single-pass collection and aggregation.**

---

### report (DEPRECATED)

Generate static HTML report. **Use `gh-year-end build` instead.**

---

### validate (DEPRECATED)

Validate cached collection data integrity. **No longer needed with single-pass collection that eliminates intermediate files.**

---

## Typical Workflows

### First-Time Full Report

```bash
# 1. Set GitHub token
export GITHUB_TOKEN=ghp_xxxxxxxxxxxxx

# 2. Run full pipeline
gh-year-end all -c config/config.yaml

# 3. View report
python -m http.server -d site/2025
```

### Incremental Development

```bash
# Collect data once (generates metrics JSON)
gh-year-end collect -c config/config.yaml

# Iterate on site templates/styling
gh-year-end build -c config/config.yaml

# Force re-collection if needed
gh-year-end collect -c config/config.yaml --force
```

### Force Re-collection

```bash
# Re-collect data (useful if config or time window changed)
gh-year-end collect -c config/config.yaml --force

# Or re-run complete pipeline
gh-year-end all -c config/config.yaml --force
```

---

## Data Pipeline Flow

```
┌─────────────────┐
│  GitHub API     │
└────────┬────────┘
         │
         ▼ collect (single-pass with in-memory aggregation)
┌─────────────────┐
│  Metrics JSON   │  site/{year}/data/
│  - summary      │  - summary.json
│  - leaderboards │  - leaderboards.json
│  - time series  │  - timeseries.json
│  - repo health  │  - repo_health.json
│  - hygiene      │  - hygiene_scores.json
│  - awards       │  - awards.json
└────────┬────────┘
         │
         ▼ build
┌─────────────────┐
│  Static Site    │  site/{year}/
│  - HTML         │  - index.html
│  - JSON         │  - summary.html
│  - D3 viz       │  - leaderboards.html
│                 │  - repos.html
│                 │  - awards.html
│                 │  - assets/[css|js]/
└─────────────────┘
```

---

## Storage Structure

```
.
├── config/
│   ├── config.yaml          # Main configuration
│   └── awards.yaml          # Awards definitions
│
└── site/
    └── 2025/
        ├── index.html
        ├── summary.html
        ├── leaderboards.html
        ├── repos.html
        ├── awards.html
        ├── data/
        │   ├── summary.json
        │   ├── leaderboards.json
        │   ├── timeseries.json
        │   ├── repo_health.json
        │   ├── hygiene_scores.json
        │   └── awards.json
        └── assets/
            ├── css/
            └── js/
```

---

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | General error (exception during execution) |
| 130 | Interrupted by user (Ctrl+C) |

---

## Troubleshooting

### No metrics data found

**Error:**
```
Error: No metrics data found at site/{year}/data
```

**Cause:**

Attempted to run `build` before running `collect`.

**Solution:**

```bash
# Run collection first
gh-year-end collect -c config/config.yaml

# Then build
gh-year-end build -c config/config.yaml
```

---

### Missing required JSON files

**Error:**
```
Error: Missing required JSON files: summary.json, leaderboards.json
```

**Cause:**

Metrics JSON files are incomplete or missing.

**Solution:**

```bash
# Re-run collection to generate metrics
gh-year-end collect -c config/config.yaml --force
```

---

### GitHub API rate limit exceeded

**Symptoms:**

- Collection slows down significantly
- Many 403 responses in verbose output
- Rate limit samples show remaining=0

**Solution:**

Collection handles rate limiting automatically:

1. Sleeps until rate limit resets
2. Uses adaptive concurrency to avoid secondary limits
3. Samples rate limit endpoint periodically

No action required. Wait for collection to complete.

To reduce wait time:

- Use a GitHub App token (higher rate limits)
- Reduce `rate_limit.max_concurrency` in config
- Increase `rate_limit.min_sleep_seconds` to be more conservative

---

### Authentication failure

**Error:**
```
401 Unauthorized
```

**Cause:**

Missing or invalid `GITHUB_TOKEN` environment variable.

**Solution:**

```bash
# Generate token at https://github.com/settings/tokens
# Required scopes: repo, read:org, read:user

export GITHUB_TOKEN=ghp_xxxxxxxxxxxxx

# Verify token
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user
```

---

### Permission denied (403)

**Error:**
```
403 Forbidden
```

**Cause:**

GitHub token lacks required permissions for target org/user.

**Solution:**

For organization targets:

1. Ensure token has `read:org` scope
2. Ensure user is member of organization
3. Check organization SSO requirements (may need token authorization)

For repository-specific errors:

1. Ensure token has `repo` scope (or `public_repo` for public repos only)
2. Ensure user has read access to repository

---

### Out of memory

**Symptoms:**

- Process killed during normalization or metrics
- `MemoryError` exception

**Solution:**

```bash
# Process repos in smaller batches by targeting specific repos
# Edit config.yaml to exclude large/inactive repos

# Or increase system memory/swap
# Or use a machine with more RAM
```

---

### Disk space full

**Error:**
```
OSError: [Errno 28] No space left on device
```

**Solution:**

```bash
# Check disk usage
df -h

# Check data directory size
du -sh data/

# Clean up old data
rm -rf data/raw/year=2024/
rm -rf data/curated/year=2024/
rm -rf data/metrics/year=2024/
rm -rf site/2024/

# Or change storage.root in config to different volume
```

---

### Template or asset errors

**Error:**
```
FileNotFoundError: [template or asset file]
```

**Cause:**

Missing template files or assets in repository.

**Solution:**

```bash
# Ensure complete checkout
git status
git pull

# Verify templates exist
ls -la site/

# Reinstall package
uv sync --refresh
```

---

## See Also

- [config/schema.json](../config/schema.json) - Configuration schema
- [CLAUDE.md](../CLAUDE.md) - Project instructions and standards
- [docs/](../docs/) - Additional documentation
