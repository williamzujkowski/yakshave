{% extends "base.html" %}

{% block title %}{{ config.report.title }} - Repositories{% endblock %}
{% block nav_repos %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Repository Health Dashboard</h1>
    <p class="lead">Health metrics, hygiene scores, and activity analysis</p>
</div>

<section class="repo-filters-section">
    <div class="filters-bar">
        <input type="text" id="repo-search" placeholder="Search repositories..." class="search-input">
        <select id="health-filter" class="filter-select">
            <option value="all">All Repositories</option>
            <option value="healthy">Healthy</option>
            <option value="warning">Needs Attention</option>
            <option value="critical">Critical</option>
        </select>
        <select id="sort-repos" class="filter-select">
            <option value="activity">Most Active</option>
            <option value="hygiene">Best Hygiene</option>
            <option value="contributors">Most Contributors</option>
            <option value="prs">Most PRs</option>
        </select>
    </div>
</section>

<section class="repo-overview-section">
    <h2>Repository Overview</h2>
    <div class="overview-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ repo_summary.healthy_count | default(0) }}</div>
                <div class="stat-label">Healthy Repositories</div>
            </div>
        </div>

        <div class="stat-card stat-card-warning">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ repo_summary.warning_count | default(0) }}</div>
                <div class="stat-label">Need Attention</div>
            </div>
        </div>

        <div class="stat-card stat-card-info">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ repo_summary.avg_hygiene_score | default(0) | round(1) }}</div>
                <div class="stat-label">Average Hygiene Score</div>
            </div>
        </div>

        <div class="stat-card stat-card-success">
            <div class="stat-icon">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ repo_summary.avg_contributors | default(0) | round(1) }}</div>
                <div class="stat-label">Avg Contributors</div>
            </div>
        </div>
    </div>
</section>

<section class="repo-health-section">
    <h2>Repository Health Matrix</h2>
    <div class="table-responsive">
        <table class="data-table" id="repos-table">
            <thead>
                <tr>
                    <th>Repository</th>
                    <th class="sortable" data-sort="hygiene_score">
                        Hygiene Score
                        <svg class="sort-icon" width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                        </svg>
                    </th>
                    <th class="sortable" data-sort="prs_merged">PRs Merged</th>
                    <th class="sortable" data-sort="active_contributors_365d">Contributors</th>
                    <th class="sortable" data-sort="review_coverage">Review Coverage</th>
                    <th class="sortable" data-sort="median_time_to_merge">Merge Time</th>
                    <th>Health Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for repo in repos %}
                <tr data-repo-id="{{ repo.repo_id }}">
                    <td class="repo-name">
                        <div class="repo-info">
                            <a href="https://github.com/{{ repo.full_name }}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="repo-link">
                                {{ repo.name }}
                            </a>
                            {% if repo.is_private %}
                            <span class="badge badge-private">Private</span>
                            {% endif %}
                            {% if repo.language %}
                            <span class="badge badge-language">{{ repo.language }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="hygiene-score-cell">
                            <span class="score-badge score-{{ repo.hygiene_score_category | default('medium') }}">
                                {{ repo.hygiene_score | default(0) }}
                            </span>
                            <div class="score-bar">
                                <div class="score-fill" style="width: {{ repo.hygiene_score | default(0) }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>{{ repo.prs_merged | default(0) }}</td>
                    <td>{{ repo.active_contributors_365d | default(0) }}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ repo.review_coverage | default(0) }}%"></div>
                            <span class="progress-text">{{ repo.review_coverage | default(0) }}%</span>
                        </div>
                    </td>
                    <td>{{ repo.median_time_to_merge | default('N/A') }}</td>
                    <td>
                        <span class="status-badge status-{{ repo.health_status | default('healthy') }}">
                            {{ repo.health_status | default('Healthy') | capitalize }}
                        </span>
                    </td>
                    <td>
                        <button class="btn-icon" onclick="showRepoDetails('{{ repo.repo_id }}')" aria-label="View details">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286z"/>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

{% if hygiene %}
<section class="hygiene-breakdown-section">
    <h2>Hygiene Breakdown</h2>
    <div class="hygiene-grid">
        <div class="hygiene-card">
            <h3>Security Policies</h3>
            <div class="hygiene-stat">
                <div class="hygiene-chart">
                    <div id="chart-security-policies" class="chart"></div>
                </div>
                <div class="hygiene-details">
                    <div class="hygiene-item">
                        <span class="hygiene-label">SECURITY.md</span>
                        <span class="hygiene-value">{{ hygiene.security_md_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                    <div class="hygiene-item">
                        <span class="hygiene-label">Security Features</span>
                        <span class="hygiene-value">{{ hygiene.security_features_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="hygiene-card">
            <h3>Code Ownership</h3>
            <div class="hygiene-stat">
                <div class="hygiene-chart">
                    <div id="chart-codeowners" class="chart"></div>
                </div>
                <div class="hygiene-details">
                    <div class="hygiene-item">
                        <span class="hygiene-label">CODEOWNERS</span>
                        <span class="hygiene-value">{{ hygiene.codeowners_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                    <div class="hygiene-item">
                        <span class="hygiene-label">Branch Protection</span>
                        <span class="hygiene-value">{{ hygiene.branch_protection_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="hygiene-card">
            <h3>CI/CD</h3>
            <div class="hygiene-stat">
                <div class="hygiene-chart">
                    <div id="chart-ci-workflows" class="chart"></div>
                </div>
                <div class="hygiene-details">
                    <div class="hygiene-item">
                        <span class="hygiene-label">With Workflows</span>
                        <span class="hygiene-value">{{ hygiene.ci_workflows_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                    <div class="hygiene-item">
                        <span class="hygiene-label">Avg Workflows/Repo</span>
                        <span class="hygiene-value">{{ hygiene.avg_workflows | default(0) | round(1) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="hygiene-card">
            <h3>Documentation</h3>
            <div class="hygiene-stat">
                <div class="hygiene-chart">
                    <div id="chart-documentation" class="chart"></div>
                </div>
                <div class="hygiene-details">
                    <div class="hygiene-item">
                        <span class="hygiene-label">README.md</span>
                        <span class="hygiene-value">{{ hygiene.readme_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                    <div class="hygiene-item">
                        <span class="hygiene-label">CONTRIBUTING.md</span>
                        <span class="hygiene-value">{{ hygiene.contributing_count | default(0) }}/{{ repos | length }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% else %}
<section class="hygiene-breakdown-section">
    <h2>Hygiene Breakdown</h2>
    <div class="hygiene-unavailable">
        <p>Detailed hygiene metrics are not available for this year's data collection.</p>
        <p>Repository health status is based on activity metrics (PRs merged and active contributors).</p>
    </div>
</section>
{% endif %}

<!-- Repository Detail Modal -->
<div id="repo-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeRepoModal()"></div>
    <div class="modal-content modal-wide">
        <button class="modal-close" onclick="closeRepoModal()" aria-label="Close modal">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
        </button>
        <div id="modal-repo-content">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="assets/js/charts.js"></script>
<script src="assets/js/repos.js"></script>
<script>
    // Load data
    const reposData = {{ repos | tojson }};
    const hygieneData = {{ hygiene | tojson }};

    // Render charts only if hygiene data is available
    {% if hygiene %}
    if (typeof renderSecurityPoliciesChart === 'function' && hygieneData) {
        renderSecurityPoliciesChart('#chart-security-policies', hygieneData);
    }
    if (typeof renderCodeownersChart === 'function' && hygieneData) {
        renderCodeownersChart('#chart-codeowners', hygieneData);
    }
    if (typeof renderCIWorkflowsChart === 'function' && hygieneData) {
        renderCIWorkflowsChart('#chart-ci-workflows', hygieneData);
    }
    if (typeof renderDocumentationChart === 'function' && hygieneData) {
        renderDocumentationChart('#chart-documentation', hygieneData);
    }
    {% endif %}

    // Initialize repo table features
    if (typeof initRepoTable === 'function') {
        initRepoTable('#repos-table', reposData);
    }
</script>
{% endblock %}
