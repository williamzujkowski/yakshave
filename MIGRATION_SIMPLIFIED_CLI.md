# Migration Guide: Simplified CLI Architecture

## Summary

The CLI has been simplified from 9 commands to 3 commands, eliminating the multi-phase pipeline in favor of single-pass collection with in-memory aggregation.

## What Changed

### NEW Commands

| Command | Purpose |
|---------|---------|
| `collect` | Collect GitHub data and generate metrics JSON (single-pass with in-memory aggregation) |
| `build` | Build static HTML site from metrics JSON |
| `all` | Run complete pipeline (collect + build) |

### DEPRECATED Commands

| Old Command | Status | Replacement |
|-------------|--------|-------------|
| `plan` | Deprecated | Use `collect --help` |
| `status` | Deprecated | No longer needed (single-pass collection eliminates checkpoints) |
| `normalize` | Deprecated | Replaced by `collect` (single-pass) |
| `metrics` | Deprecated | Replaced by `collect` (single-pass) |
| `report` | Deprecated | Use `build` instead |
| `validate` | Deprecated | No longer needed (single-pass eliminates intermediate files) |

## Migration Examples

### Before (Multi-Phase Pipeline)

```bash
# Old workflow - 4 separate commands
gh-year-end collect -c config/config.yaml
gh-year-end normalize -c config/config.yaml
gh-year-end metrics -c config/config.yaml
gh-year-end report -c config/config.yaml
```

### After (Simplified)

```bash
# New workflow - 1 command
gh-year-end all -c config/config.yaml

# Or in 2 steps for iterative development
gh-year-end collect -c config/config.yaml  # Collect data + generate metrics JSON
gh-year-end build -c config/config.yaml    # Build site from JSON
```

## Key Differences

### Data Flow

**Before:**
```
GitHub API → Raw JSONL → Curated Parquet → Metrics Parquet → JSON → HTML
            (collect)    (normalize)        (metrics)        (report)
```

**After:**
```
GitHub API → Metrics JSON → HTML
            (collect)       (build)
```

### Storage

**Before:**
- `data/raw/` - Raw JSONL files
- `data/curated/` - Curated Parquet tables
- `data/metrics/` - Metrics Parquet tables
- `site/{year}/data/` - JSON exports
- `site/{year}/` - HTML site

**After:**
- `site/{year}/data/` - Metrics JSON (generated by collect)
- `site/{year}/` - HTML site (generated by build)

### Checkpoints

**Before:**
- Checkpoint system for resuming interrupted collection
- `--resume`, `--retry-failed`, `--from-repo` flags

**After:**
- Single-pass collection (faster, no checkpoints needed)
- Use `--force` to re-collect

## Quick Start

```bash
# Set GitHub token
export GITHUB_TOKEN=ghp_xxxxxxxxxxxxx

# Run complete pipeline
gh-year-end all -c config/config.yaml

# View report
python -m http.server -d site/2025
```

## Iterative Development

```bash
# Collect data once (generates metrics JSON)
gh-year-end collect -c config/config.yaml

# Iterate on site templates/styling (fast rebuilds)
gh-year-end build -c config/config.yaml

# Force re-collection if needed
gh-year-end collect -c config/config.yaml --force
```

## Benefits

1. **Faster**: Single-pass collection with in-memory aggregation
2. **Simpler**: 3 commands instead of 9
3. **Cleaner**: No intermediate Parquet files
4. **Easier**: No checkpoint/resume complexity
5. **More intuitive**: Collect data, build site, done

## Breaking Changes

- Removed intermediate data formats (raw JSONL, curated Parquet, metrics Parquet)
- Removed checkpoint/resume functionality
- Removed validation command
- Changed output directory structure (no more data/raw, data/curated, data/metrics)

## Documentation Updates

- Updated `/home/william/git/yakshave/CLAUDE.md` - Quick Commands section
- Updated `/home/william/git/yakshave/docs/cli-reference.md` - Complete CLI reference with new commands and deprecated commands section
